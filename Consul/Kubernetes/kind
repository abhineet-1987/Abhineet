# https://developer.hashicorp.com/consul/docs/deploy/server/k8s/platform/kind
# https://developer.hashicorp.com/consul/docs/deploy/server/k8s/helm

# Create kubernetes cluster using kind
kind create cluster --name dc1
kind get clusters
kubectl config current-context
kubectl cluster-info --context kind-dc1    # To get general information about the cluster dc1
kind delete cluster --name kind        # To delete the kind cluster

#Install Consul using helm:-
helm repo add hashicorp https://helm.releases.hashicorp.com
helm search repo hashicorp/consul     # list the latest available versions for consul chart
helm search repo hashicorp/consul --versions  # list all the available versions for consul chart

helm install --values values.yaml consul hashicorp/consul --create-namespace --namespace consul --version "1.1.0"
OR
helm install --values values.yaml consul hashicorp/consul --create-namespace --namespace consul   # to install latest version.

Note: Refer to basic-values.yaml kept at https://github.com/abhineet-1987/Abhineet/tree/main/Consul/Kubernetes for setup.
Please note that with replicas set to 3, 2 pods will be in pending state and the other one running with 0/1 READY.
Error while describing pending pods "scheduler  0/1 nodes are available: 1 node(s) didn't satisfy existing pods anti-affinity rules. preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod."
Fix: Remove Affinity section (kubectl edit ...) from stateful set consul-server which prevent other replicas of sts (stateful set) to be scheduled on single node. As we have installed using kind, it created single node cluster.
Then run : kubectl rollout restart sts consul-server -n consul
and then delete the previous sts pods as: kubectl delete pods -n consul consul-server-0 consul-server-1 consul-server-2

abhineet@abhineet-M17KGYKQHL Consul-K8 % kubectl get nodes
NAME                STATUS   ROLES           AGE   VERSION
dc1-control-plane   Ready    control-plane   37m   v1.33.1

Set env variables to interact with consul cluster:-
export CONSUL_HTTP_TOKEN=$(kubectl get --namespace consul secrets/consul-bootstrap-acl-token --template={{.data.token}} | base64 -d)
export CONSUL_HTTP_ADDR=https://127.0.0.1:8501
export CONSUL_HTTP_SSL_VERIFY=false
export CONSUL_HTTP_TOKEN=eaaf06a0-4754-0d96-6dc3-bca459e5b8a7

kubectl port-forward svc/consul-ui --namespace consul 8501:443  # In another terminal

abhineet@abhineet-M17KGYKQHL Consul-K8 % kubectl get statefulset -n consul
NAME            READY   AGE
consul-server   3/3     44m

abhineet@abhineet-M17KGYKQHL Consul-K8 % kubectl get pods -n consul
NAME                                           READY   STATUS      RESTARTS       AGE
consul-connect-injector-8886c4b5f-xxl7b        1/1     Running     11 (19m ago)   45m
consul-gateway-resources-6vdtl                 0/1     Completed   0              45m
consul-server-0                                1/1     Running     0              23m
consul-server-1                                1/1     Running     0              24m
consul-server-2                                1/1     Running     0              23m
consul-server-acl-init-cleanup-jcqn2           0/1     Completed   0              45m
consul-webhook-cert-manager-56d6d7dd49-jvcsb   1/1     Running     0              45m

abhineet@abhineet-M17KGYKQHL Consul-K8 % consul members
Node             Address           Status  Type    Build   Protocol  DC   Partition  Segment
consul-server-0  10.244.0.18:8301  alive   server  1.21.0  2         dc1  default    <all>
consul-server-1  10.244.0.17:8301  alive   server  1.21.0  2         dc1  default    <all>
consul-server-2  10.244.0.19:8301  alive   server  1.21.0  2         dc1  default    <all>

abhineet@abhineet-M17KGYKQHL Consul-K8 % consul operator raft list-peers
Node             ID                                    Address           State     Voter  RaftProtocol  Commit Index  Trails Leader By
consul-server-0  69d51410-5e7f-e303-fbe1-0b0771091b61  10.244.0.18:8300  follower  true   3             187           0 commits
consul-server-1  5796b90b-c5ae-324f-b79a-8303342cd63f  10.244.0.17:8300  leader    true   3             187           -
consul-server-2  07021717-abe0-1813-56ae-6454b22ea4a1  10.244.0.19:8300  follower  true   3             187           0 commits

##### You may login to the pods using:-
exec -it consul-server-1 -n consul -- sh

and run the consul CLI commands post exporting export CONSUL_HTTP_TOKEN=eaaf06a0-4754-0d96-6dc3-bca459e5b8a7

To find the config-dir and data-dir run "ps -ef | grep -i consul" 

