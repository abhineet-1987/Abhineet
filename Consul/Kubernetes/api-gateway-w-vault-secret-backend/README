Note: Here I am deploying Consul and Vault both in default kubernetes namespace, but will deploy api gateway in consul namespace

https://developer.hashicorp.com/consul/docs/deploy/server/k8s/enterprise 
https://support.hashicorp.com/hc/en-us/articles/21375557655059-Consul-Vault-Integration-on-K8s-using-Helm-Chart
https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-minikube-tls

helm install vault hashicorp/vault --values values.yaml

# Vault port forwarding from another terminal:
kubectl port-forward svc/vault 8200:8200

# Setting env variable
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=xxxxxxxxxxxxxx

# slight change from the above KB:-
vault write pki/roles/consul-server \
      allowed_domains="*" \
      allow_subdomains=true \
      allow_glob_domains=true \
      allow_bare_domains=true \
      allow_any_name=false \
      enforce_hostnames=false \
      require_cn=false \
      ttl="72h"

KUBE_HOST="https://kubernetes.default.svc"    (since I am using Kind here)

vault write auth/kubernetes/role/consul-server \
  bound_service_account_names=consul-server \
  bound_service_account_namespaces=default \
  policies="gossip-policy,consul-server,connect" \
  ttl=24h 

vault write auth/kubernetes/role/consul-client \
  bound_service_account_names=consul-client \
  bound_service_account_namespaces=default \
  policies="gossip-policy,ca-policy" \
  ttl=24h 

vault write auth/kubernetes/role/consul-ca \
  bound_service_account_names="*" \
  bound_service_account_namespaces=default \
  policies="ca-policy" \
  ttl=1h






