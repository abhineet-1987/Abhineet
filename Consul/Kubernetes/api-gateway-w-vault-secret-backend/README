Note: Here I am deploying Consul and Vault both in default kubernetes namespace, but will deploy api gateway in consul namespace

https://developer.hashicorp.com/consul/docs/deploy/server/k8s/enterprise 
https://support.hashicorp.com/hc/en-us/articles/21375557655059-Consul-Vault-Integration-on-K8s-using-Helm-Chart
https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-minikube-tls
https://support.hashicorp.com/hc/en-us/articles/41900709789075-How-to-implement-traffic-failover-routing-for-Consul-service-hitting-external-sites-via-terminating-gateway

helm install vault hashicorp/vault --values vault_values.yaml

# Vault port forwarding from another terminal:
kubectl port-forward svc/vault 8200:8200

# Setting env variable
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=xxxxxxxxxxxxxx

# slight change from the above KB:-
vault write pki/roles/consul-server \
      allowed_domains="*" \
      allow_subdomains=true \
      allow_glob_domains=true \
      allow_bare_domains=true \
      allow_any_name=false \
      enforce_hostnames=false \
      require_cn=false \
      ttl="72h"

KUBE_HOST="https://kubernetes.default.svc"    (since I am using Kind here)

vault write auth/kubernetes/role/consul-server \
  bound_service_account_names=consul-server \
  bound_service_account_namespaces=default \
  policies="gossip-policy,consul-server,connect" \
  ttl=24h 

vault write auth/kubernetes/role/consul-client \
  bound_service_account_names=consul-client \
  bound_service_account_namespaces=default \
  policies="gossip-policy,ca-policy" \
  ttl=24h 

vault write auth/kubernetes/role/consul-ca \
  bound_service_account_names="*" \
  bound_service_account_namespaces=default \
  policies="ca-policy" \
  ttl=1h

# Consul license setup
secret=$(cat license.hclic)
kubectl create secret generic consul-ent-license --from-literal="key=${secret}"

helm install consul hashicorp/consul --values=consul_values.yaml

export CONSUL_HTTP_ADDR=https://127.0.0.1:8501
export CONSUL_HTTP_SSL_VERIFY=false
kubectl get secret consul-bootstrap-acl-token -o yaml
echo <token-copied-from-above> | base64 -d
export CONSUL_HTTP_TOKEN=xxxxxxxxxxxx
kubectl port-forward svc/consul-server 8501:8501    (on other terminal)






