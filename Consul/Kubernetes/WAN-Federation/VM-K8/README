Reference Documents: 
https://developer.hashicorp.com/consul/docs/east-west/wan-federation/k8s-vm 
https://developer.hashicorp.com/consul/docs/secure/encryption/tls/mtls#federated-consul-datacenter 
https://developer.hashicorp.com/consul/docs/secure/encryption/gossip/enable

Steps:
--------Create CA and Server TLS certificates:

consul tls ca create
consul tls cert create -server -dc dc1 -node primary-dc1-node -domain=consul -additional-dnsname="server.dc2.consul"

-------- Create Gossip Key
consul keygen

------Consul Server Config #################

# cat consul.hcl
# -------------------------
# Core server configuration
# -------------------------
server           = true
bootstrap_expect = 1
datacenter       = "dc1"
primary_datacenter = "dc1"
domain            = "consul"
node_name         = "primary-dc1-node"
encrypt = "xxxxxxxxxxxxxxxxx"

bind_addr   = "0.0.0.0"
client_addr = "0.0.0.0"
data_dir    = "/opt/data"
license_path = "/etc/consul.d/license.hclic"


leave_on_terminate = true
enable_debug       = false

# -------------------------
# ACL configuration
# -------------------------
acl {
  enabled                   = true
  default_policy            = "deny"
  down_policy               = "extend-cache"
  enable_token_persistence  = true
  enable_token_replication  = true
  tokens {
    agent = "XXXX-ad3892302ba0"
    replication = "XXXX-ad3892302ba0"
    default = "XXXX-ad3892302ba0"
  }
}

# -------------------------
# Connect / Service Mesh
# -------------------------
connect {
  enabled = true
  enable_mesh_gateway_wan_federation = true
}


enable_central_service_config = true

# -------------------------
# Limits
# -------------------------
limits {
  request_limits {
    mode       = "disabled"
    read_rate  = -1
    write_rate = -1
  }
}

# -------------------------
# Autopilot
# -------------------------
autopilot {
  min_quorum                = 1
  disable_upgrade_migration = true
}

# -------------------------
# Ports (merged from all files)
# -------------------------
ports {
  http      = -1
  https     = 8501
  grpc_tls      = 8502
}

# -------------------------
# TLS configuration
# -------------------------
tls {
  internal_rpc {
    verify_incoming        = true
    verify_outgoing = true
    verify_server_hostname = true
  }

grpc {
    verify_incoming = false
  }

  defaults {
    ca_file   = "/etc/consul.d/tls/consul-agent-ca.pem"
    cert_file = "/etc/consul.d/tls/dc1-server-consul-0.pem"
    key_file  = "/etc/consul.d/tls/dc1-server-consul-0-key.pem"
  }
}

# -------------------------
# UI
# -------------------------
ui_config {
  enabled = true
}
############################################################## 
Configure the anonymous token policy, first create a policy with the mentioned rules as given below (Refer here), then attach it to the anonymous token:-

echo 'partition_prefix "" {
  namespace_prefix "" {
    node_prefix "" {
      policy = "read"
    }
    service_prefix "" {
      policy = "read"
    }
  }
}' | consul acl policy create -name anonymous -rules -


consul acl token update -id 00000000-0000-0000-0000-000000000002 -policy-name anonymous
 
Register and start the mesh gateway on the VM:-

nohup consul connect envoy -gateway=mesh -register -expose-servers -service "gateway-primary" -address "<private-ip-vm>:8443" -wan-address "<public-ip-vm>:8443"  -grpc-addr "https://<private-ip-vm>:8502" -grpc-ca-file "/etc/consul.d/tls/consul-agent-ca.pem" &
 
Create the Configuration entry for proxy defaults:-

# cat proxy-defaults.hcl
Kind = "proxy-defaults"
Name = "global"
Config {
  protocol = "http"
}
MeshGateway {
  Mode = "local"
}
     
consul config write proxy-defaults.hcl
 
Kubernetes Secondary Cluster Setup:-
 
Create Kubernetes federation secret
abhineet@abhineet-M17KGYKQHL helm % kubectl create secret generic consul-federation \
  --from-file=caCert=consul-agent-ca.pem \
  --from-file=caKey=consul-agent-ca-key.pem \
  --from-literal=replicationToken="XXXX-ad3892302ba0"
Please note: To keep things simple, I have used the same master bootstrap token of the primary cluster as the replication token for the secondary cluster.
 
Values.yaml for Kubernetes Secondary Cluster :-
global:
  name: consul
  datacenter: dc2
  image: hashicorp/consul-enterprise:1.21.4-ent
  enterpriseLicense:
    secretName: consul-ent-license
    secretKey: key
  tls:
    enabled: true
    caCert:
      secretName: consul-federation
      secretKey: caCert
    caKey:
      secretName: consul-federation
      secretKey: caKey

  # Delete this acls section if ACLs are disabled.
  acls:
    manageSystemACLs: true
    replicationToken:
      secretName: consul-federation
      secretKey: replicationToken

  federation:
    enabled: true
    k8sAuthMethodHost: https://xxxxxxxxxxxxxxxxx.gr7.us-west-2.eks.amazonaws.com
    primaryDatacenter: dc1
    primaryGateways: ["<private-ip-vm>:8443"]


connectInject:
  enabled: true
meshGateway:
  enabled: true
server:
  extraConfig: |
    {
      "primary_gateways": ["<private-ip-vm>"]
    }
  enabled: true
  replicas: 1
 
For validating the WAN federation setup, refer this.
 
Validation results :-
$ consul members -wan
Node                  Address          Status  Type    Build       Protocol  DC   Partition  Segment
consul-server-0.dc2   10.0.6.207:8302  alive   server  1.21.4+ent  2         dc2  default    <all>
primary-dc1-node.dc1  10.0.5.32:8302   alive   server  1.21.4+ent  2         dc1  default    <all>
 
Validation results for successful ACL replication (Refer this ). Execute this on consul server of secondary cluster:-
$ curl -k https://127.0.0.1:8501/v1/acl/replication?pretty
{
    "Enabled": true,
    "Running": true,
    "SourceDatacenter": "dc1",
    "ReplicationType": "tokens",
    "ReplicatedIndex": 10474,
    "ReplicatedRoleIndex": 10475,
    "ReplicatedTokenIndex": 10491,
    "LastSuccess": "2026-02-14T20:26:01Z"
}

