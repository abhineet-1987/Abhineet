Reference Documents: 
https://developer.hashicorp.com/consul/docs/east-west/wan-federation/k8s-vm 
https://developer.hashicorp.com/consul/docs/secure/encryption/tls/mtls#federated-consul-datacenter 
https://developer.hashicorp.com/consul/docs/secure/encryption/gossip/enable

Steps:
--------Create CA and Server TLS certificates:

consul tls ca create
consul tls cert create -server -dc dc1 -node primary-dc1-node -domain=consul -additional-dnsname="server.dc2.consul"

-------- Create Gossip Key
consul keygen

------Consul Server Config #################

Create consul.hcl as defined in this folder.

############################################################## 
Configure the anonymous token policy, first create a policy with the mentioned rules as given below (Refer here), then attach it to the anonymous token:-

echo 'partition_prefix "" {
  namespace_prefix "" {
    node_prefix "" {
      policy = "read"
    }
    service_prefix "" {
      policy = "read"
    }
  }
}' | consul acl policy create -name anonymous -rules -


consul acl token update -id 00000000-0000-0000-0000-000000000002 -policy-name anonymous
 
Register and start the mesh gateway on the VM:-

nohup consul connect envoy -gateway=mesh -register -expose-servers -service "gateway-primary" -address "<private-ip-vm>:8443" -wan-address "<public-ip-vm>:8443"  -grpc-addr "https://<private-ip-vm>:8502" -grpc-ca-file "/etc/consul.d/tls/consul-agent-ca.pem" &
 
Create the Configuration entry for proxy defaults:-

# cat proxy-defaults.hcl
Kind = "proxy-defaults"
Name = "global"
Config {
  protocol = "http"
}
MeshGateway {
  Mode = "local"
}
     
consul config write proxy-defaults.hcl
 
Kubernetes Secondary Cluster Setup:-
 
Create Kubernetes federation secret
abhineet@abhineet-M17KGYKQHL helm % kubectl create secret generic consul-federation \
  --from-file=caCert=consul-agent-ca.pem \
  --from-file=caKey=consul-agent-ca-key.pem \
  --from-literal=replicationToken="XXXX-ad3892302ba0"
  --from-literal=gossipEncryptionKey="XXXXXXXXXXXXX"
Please note: To keep things simple, I have used the same master bootstrap token of the primary cluster as the replication token for the secondary cluster.

-------- Create values.yaml for K8 cluster as given in folder here.
 
For validating the WAN federation setup, refer this.
 
Validation results :-
$ consul members -wan
Node                  Address          Status  Type    Build       Protocol  DC   Partition  Segment
consul-server-0.dc2   10.0.6.207:8302  alive   server  1.21.4+ent  2         dc2  default    <all>
primary-dc1-node.dc1  10.0.5.32:8302   alive   server  1.21.4+ent  2         dc1  default    <all>
 
Validation results for successful ACL replication (Refer this ). Execute this on consul server of secondary cluster:-
$ curl -k https://127.0.0.1:8501/v1/acl/replication?pretty
{
    "Enabled": true,
    "Running": true,
    "SourceDatacenter": "dc1",
    "ReplicationType": "tokens",
    "ReplicatedIndex": 10474,
    "ReplicatedRoleIndex": 10475,
    "ReplicatedTokenIndex": 10491,
    "LastSuccess": "2026-02-14T20:26:01Z"
}

